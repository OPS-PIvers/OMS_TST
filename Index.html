<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Google Fonts: Lexend -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Tailwind CSS with Custom Config -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Lexend', 'sans-serif'],
          },
          colors: {
            ops: {
              blue: '#2d3f89',       // Primary Blue
              'blue-dark': '#1d2a5d', // Darkest Blue
              'blue-light': '#4356a0',
              'blue-lighter': '#eaecf5', // Info Background
              red: '#ad2122',        // Primary Red
              'red-dark': '#7a1718',
              'red-light': '#c13435',
              'red-lighter': '#e5c7c7', // Warning Background
              gray: {
                dark: '#333333',
                DEFAULT: '#666666',
                light: '#999999',
                lighter: '#CCCCCC'
              }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Loader using Brand Colors */
    .loader {
      border: 4px solid #eaecf5; /* ops-blue-lighter */
      border-top: 4px solid #2d3f89; /* ops-blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    body {
      color: #333333; /* ops-gray-dark */
    }
    
    /* Smooth transitions for tabs */
    .tab-btn {
      transition: all 0.2s ease-in-out;
    }
    
    /* Toast Animations */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .toast-enter {
      animation: slideIn 0.3s ease-out forwards;
    }
    .toast-exit {
      animation: fadeOut 0.3s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <!-- Global Tooltip -->
  <div id="global-tooltip" class="fixed hidden bg-ops-blue-dark text-white text-xs rounded-lg shadow-xl p-4 z-[100] max-w-xs pointer-events-none transition-opacity duration-200 opacity-0 border border-ops-blue-light"></div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-5 right-5 flex flex-col gap-3 pointer-events-none" style="z-index: 9999;"></div>

  <!-- Setup & Loading State -->
  <div id="app-loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
    <div class="loader mb-4"></div>
    <p class="text-ops-gray font-medium">Authenticating & Loading Directory...</p>
  </div>

  <!-- Main App Container (Hidden until loaded) -->
  <div id="app-container" class="hidden flex flex-col min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-ops-blue text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <div class="flex items-center">
            <!-- Brand Logo Area -->
            <div class="flex-shrink-0 flex items-center gap-3">
              <div class="bg-white text-ops-blue rounded-full h-10 w-10 flex items-center justify-center shadow-sm">
                <i class="fas fa-layer-group text-xl"></i>
              </div>
              <div>
                <span class="font-bold text-xl tracking-tight block leading-tight">Orono Middle School</span>
                <span class="text-xs font-light text-blue-100 uppercase tracking-wider block">TST Manager</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-6">
             <button id="admin-add-btn" onclick="openAdminCreateRequestModal()" class="hidden bg-white text-ops-blue hover:bg-blue-50 transition px-3 py-2 rounded font-bold text-xs uppercase tracking-wide shadow-sm">
              <i class="fas fa-plus-circle mr-1"></i> Add Request
            </button>
            <div id="user-info" class="text-sm font-light text-blue-100 hidden md:block"></div>
            <button onclick="refreshApp()" class="text-xs bg-ops-blue-dark hover:bg-opacity-80 transition px-4 py-2 rounded text-white font-medium uppercase tracking-wide">
              Refresh
            </button>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex space-x-2 pb-0 overflow-x-auto mt-2" id="nav-tabs">
          <!-- Injected via JS -->
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
      <div id="view-container">
        <!-- Views injected here -->
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-6">
      <div class="max-w-7xl mx-auto px-4 text-center text-xs text-ops-gray-light">
        &copy; Orono Technology. All rights reserved.
      </div>
    </footer>

  </div>

  <!-- Modal Template -->
  <div id="modal-backdrop" class="fixed inset-0 bg-ops-blue-dark bg-opacity-75 hidden z-40 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all border-t-4 border-ops-blue">
      <div class="flex justify-between items-center bg-gray-50 px-6 py-4 border-b border-gray-100">
        <h3 id="modal-title" class="text-xl font-bold text-ops-blue-dark">Modal Title</h3>
        <button onclick="closeModal()" class="text-ops-gray-light hover:text-ops-red transition rounded-full p-1">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <div id="modal-content" class="p-8 max-h-[70vh] overflow-y-auto">
        <!-- Content -->
      </div>
    </div>
  </div>

  <script>
    // --- Toast Notification System ---
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      // ... existing toast logic ...
      // Icons and Colors based on type
      let icon, bgClass, textClass, borderClass;
      
      if (type === 'success') {
        icon = 'fa-check-circle';
        bgClass = 'bg-white';
        textClass = 'text-green-800';
        borderClass = 'border-green-500';
      } else if (type === 'error') {
        icon = 'fa-exclamation-circle';
        bgClass = 'bg-white';
        textClass = 'text-red-800';
        borderClass = 'border-red-500';
      } else { // info
        icon = 'fa-info-circle';
        bgClass = 'bg-white';
        textClass = 'text-ops-blue';
        borderClass = 'border-ops-blue';
      }

      const toast = document.createElement('div');
      toast.className = `toast-enter pointer-events-auto transform w-80 max-w-sm rounded-lg shadow-lg border-l-4 ${borderClass} ${bgClass} p-4 flex items-start gap-3`;
      
      toast.innerHTML = `
        <div class="flex-shrink-0 mt-0.5">
          <i class="fas ${icon} ${textClass} text-lg"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium ${textClass}">${message}</p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition">
          <i class="fas fa-times"></i>
        </button>
      `;

      container.appendChild(toast);

      // Auto remove after 4 seconds
      setTimeout(() => {
        if(toast.parentElement) {
          toast.classList.remove('toast-enter');
          toast.classList.add('toast-exit');
          toast.addEventListener('animationend', () => toast.remove());
        }
      }, 4000);
    }

    // --- Tooltip System ---
    function showTooltip(e, content) {
      const el = document.getElementById('global-tooltip');
      el.innerHTML = content;
      el.classList.remove('hidden');
      // Small delay to allow transition
      requestAnimationFrame(() => el.classList.remove('opacity-0'));
      
      moveTooltip(e);
    }

    function moveTooltip(e) {
      const el = document.getElementById('global-tooltip');
      if (el.classList.contains('hidden')) return;

      const x = e.clientX;
      const y = e.clientY;
      
      // Adjust positioning to avoid edge overflow
      const rect = el.getBoundingClientRect();
      const winW = window.innerWidth;
      const winH = window.innerHeight;
      
      let left = x + 15;
      let top = y + 15;
      
      if (left + rect.width > winW) left = x - rect.width - 10;
      if (top + rect.height > winH) top = y - rect.height - 10;
      
      el.style.left = `${left}px`;
      el.style.top = `${top}px`;
    }

    function hideTooltip() {
      const el = document.getElementById('global-tooltip');
      el.classList.add('opacity-0');
      setTimeout(() => el.classList.add('hidden'), 200);
    }

    // --- State Management ---
    let STATE = {
      user: null, 
      currentTab: null,
      dataCache: {}
    };
    
    // --- Constants & Helpers ---
    function getPeriodOptions(selectedVal) {
      const periods = [
        "Period 1 - 8:10 - 8:57",
        "Period 2 - 9:01 - 9:48",
        "Period 3 - 9:52 - 10:39",
        "Period 4 - 10:43 - 11:09",
        "Period 5 - 11:11 - 11:37",
        "Period 4/5 - 10:30 - 11:37",
        "Period 6 - 11:40 - 12:06",
        "Period 7 - 12:08 - 12:34",
        "Period 6/7 - 11:40 - 12:34",
        "Period 8 - 12:37 - 1:08",
        "Period 9 - 1:12 - 1:59",
        "Period 10 - 2:03 - 2:50"
      ];
      return periods.map(p => {
        // Attempt to match exact string OR legacy short number (e.g. "1" matches "Period 1...")
        // We look for "Period {selectedVal} " at the start.
        const isSelected = selectedVal === p || (selectedVal && p.startsWith(`Period ${selectedVal} `));
        return `<option value="${p}" ${isSelected ? 'selected' : ''}>${p}</option>`;
      }).join('');
    }

    // --- Initialization ---
    window.onload = function() {
      google.script.run
        .withSuccessHandler(initApp)
        .withFailureHandler(handleError)
        .getInitialData();
    };

    function initApp(data) {
      STATE.user = data;
      document.getElementById('app-loading').classList.add('hidden');
      document.getElementById('app-container').classList.remove('hidden');
      
      document.getElementById('user-info').innerHTML = `
        <span class="block font-medium">${data.name}</span>
        <span class="text-xs opacity-75">${data.role}</span>
      `;

      renderNav();
      
      if (data.role === 'Admin') {
        document.getElementById('admin-add-btn').classList.remove('hidden');
        switchTab('admin-earned');
        updateBadges(); // Fetch initial counts
      } else if (data.role === 'Teacher') {
        switchTab('teacher-totals');
      } else {
        document.getElementById('view-container').innerHTML = `
          <div class="bg-ops-red-lighter border-l-4 border-ops-red p-4 rounded text-ops-red-dark">
            <p class="font-bold">Access Denied</p>
            <p>Your email is not listed in the Staff Directory.</p>
          </div>`;
      }
    }

    function updateBadges() {
      if (STATE.user.role !== 'Admin') return;
      google.script.run.withSuccessHandler(counts => {
        const eBadge = document.getElementById('badge-earned');
        const uBadge = document.getElementById('badge-used');
        
        if (eBadge) {
           if (counts.earned > 0) {
             eBadge.textContent = counts.earned;
             eBadge.classList.remove('hidden');
           } else {
             eBadge.classList.add('hidden');
           }
        }
        
        if (uBadge) {
           if (counts.used > 0) {
             uBadge.textContent = counts.used;
             uBadge.classList.remove('hidden');
           } else {
             uBadge.classList.add('hidden');
           }
        }
      }).getDashboardCounts();
    }

    // --- Navigation Logic ---
    function renderNav() {
      const navContainer = document.getElementById('nav-tabs');
      let tabs = [];

      if (STATE.user.role === 'Admin') {
        tabs = [
          { id: 'admin-earned', label: 'TST Earned', sub: 'Pending', icon: 'fa-inbox' },
          { id: 'admin-used', label: 'TST Used', sub: 'Pending', icon: 'fa-hand-holding-usd' },
          { id: 'admin-schedule', label: 'Schedule', sub: 'Coverage', icon: 'fa-calendar-alt' },
          { id: 'admin-totals', label: 'Directory', sub: 'Finalized', icon: 'fa-users' }
        ];
      } else if (STATE.user.role === 'Teacher') {
        tabs = [
          { id: 'teacher-submit', label: 'Submit', sub: 'Earned Time', icon: 'fa-plus-circle' },
          { id: 'teacher-schedule', label: 'Schedule', sub: 'Availability', icon: 'fa-calendar-check' },
          { id: 'teacher-totals', label: 'My Report', sub: 'Totals', icon: 'fa-chart-pie' }
        ];
      }

      navContainer.innerHTML = tabs.map(t => {
        // Badge ID logic
        const badgeId = t.id === 'admin-earned' ? 'badge-earned' : (t.id === 'admin-used' ? 'badge-used' : '');
        const badgeHtml = badgeId ? `<span id="${badgeId}" class="hidden ml-2 bg-ops-red text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm"></span>` : '';
        
        return `
        <button 
          onclick="switchTab('${t.id}')"
          id="btn-${t.id}"
          class="tab-btn group flex items-center px-5 py-3 rounded-t-lg border-b-4 border-transparent hover:bg-ops-blue-light">
          <div class="relative flex items-center">
            <i class="fas ${t.icon} text-lg mr-3 group-hover:text-white transition-colors"></i>
          </div>
          <div class="text-left leading-tight">
            <div class="flex items-center">
               <span class="font-bold text-sm transition-colors">${t.label}</span>
               ${badgeHtml}
            </div>
            <div class="text-[10px] uppercase tracking-wider font-medium transition-colors">${t.sub}</div>
          </div>
        </button>
      `}).join('');
    }

    function switchTab(tabId) {
      STATE.currentTab = tabId;
      
      // Reset all tabs to inactive state
      document.querySelectorAll('#nav-tabs button').forEach(b => {
        // Remove Active Classes
        b.classList.remove('bg-gray-50', 'border-ops-blue-dark');
        
        // Add Inactive Styling (Transparent bg, light blue text)
        // Note: 'hover:bg-ops-blue-light' is already on the base class in renderNav
        
        // Reset Label Color to light blue
        const label = b.querySelector('.font-bold');
        if (label) {
            label.classList.remove('text-ops-blue');
            label.classList.add('text-blue-100', 'group-hover:text-white');
        }

        // Reset Subtext Color to dimmer blue
        const sub = b.querySelector('.uppercase');
        if (sub) {
            sub.classList.remove('text-ops-gray');
            sub.classList.add('text-blue-200', 'group-hover:text-blue-50');
        }

        // Reset Icon Color
        const icon = b.querySelector('i');
        if (icon) {
            icon.classList.remove('text-ops-blue');
            icon.classList.add('text-blue-200');
        }
      });

      const activeBtn = document.getElementById(`btn-${tabId}`);
      if (!activeBtn) return; // Guard clause

      // Apply Active Classes
      activeBtn.classList.remove('hover:bg-ops-blue-light'); // Remove hover effect for active tab
      activeBtn.classList.add('bg-gray-50', 'border-ops-blue-dark'); // Active styling
      
      // Update Inner Text Colors for Active State
      const label = activeBtn.querySelector('.font-bold');
      if (label) {
        label.classList.remove('text-blue-100', 'group-hover:text-white');
        label.classList.add('text-ops-blue');
      }
      
      const sub = activeBtn.querySelector('.uppercase');
      if (sub) {
        sub.classList.remove('text-blue-200', 'group-hover:text-blue-50');
        sub.classList.add('text-ops-gray');
      }

      const icon = activeBtn.querySelector('i');
      if (icon) {
        icon.classList.remove('text-blue-200');
        icon.classList.add('text-ops-blue');
      }

      // Loader
      const container = document.getElementById('view-container');
      container.innerHTML = `<div class="flex flex-col items-center justify-center p-20"><div class="loader mb-4"></div><span class="text-ops-gray">Loading data...</span></div>`;

      // Dispatch
      if (tabId === 'admin-earned') loadAdminEarned();
      else if (tabId === 'admin-used') loadAdminUsed();
      else if (tabId === 'admin-totals') loadAdminTotals();
      else if (tabId === 'admin-schedule') loadAdminSchedule();
      else if (tabId === 'teacher-submit') renderTeacherSubmit();
      else if (tabId === 'teacher-schedule') loadTeacherSchedule();
      else if (tabId === 'teacher-totals') loadTeacherTotals();
    }

    // --- Admin Views ---

    function loadAdminEarned() {
      // Fetch data first, then render
      if (!STATE.selectedEarned) STATE.selectedEarned = new Set();

      google.script.run.withSuccessHandler(data => {
        STATE.pendingEarned = data; 
        updateBadges(); 
        renderEarnedTable();
      }).getPendingEarned();
    }
    
    function renderEarnedTable() {
       const data = STATE.pendingEarned || [];
       const isSel = STATE.earnedSelectionMode;
       
       // Batch Action Bar
       const batchActions = isSel ? `
          <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex justify-between items-center animate-pulse-once">
            <span class="text-sm font-bold text-ops-blue-dark">
              ${STATE.selectedEarned.size} Selected
            </span>
            <div class="flex gap-2">
              <button onclick="batchAction('earned', 'deny')" class="bg-white text-ops-red border border-ops-red hover:bg-red-50 px-4 py-1.5 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition">
                Deny Selected
              </button>
              <button onclick="batchAction('earned', 'approve')" class="bg-ops-blue text-white hover:bg-ops-blue-dark px-4 py-1.5 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition">
                Approve Selected
              </button>
            </div>
          </div>
        ` : '';

        const html = `
          <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-ops-blue-lighter">
              <div>
                <h2 class="text-xl font-bold text-ops-blue-dark">Pending Earned Approvals</h2>
                <p class="text-xs text-ops-gray uppercase tracking-wider mt-1">Review & Release to Directory</p>
              </div>
              <div class="flex items-center gap-3">
                 ${isSel ? `
                   <button onclick="toggleEarnedSelectionMode()" class="bg-white text-gray-600 border border-gray-300 px-3 py-1 rounded shadow-sm hover:bg-gray-50 text-xs font-bold uppercase tracking-wide transition">
                     Cancel
                   </button>
                 ` : `
                   <button onclick="toggleEarnedSelectionMode()" class="bg-white text-ops-blue border border-ops-blue px-3 py-1 rounded shadow-sm hover:bg-blue-50 text-xs font-bold uppercase tracking-wide transition">
                     <i class="fas fa-check-square mr-1"></i> Select
                   </button>
                 `}
              </div>
            </div>
            ${batchActions}
            ${data.length === 0 ? '<div class="p-12 text-center"><i class="fas fa-check-circle text-4xl text-gray-300 mb-4"></i><p class="text-ops-gray">All caught up! No pending approvals.</p></div>' : 
              `<div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      ${isSel ? `<th class="px-6 py-3 text-left bg-gray-50 w-10"><input type="checkbox" onchange="toggleSelectAll('earned', this)" class="rounded text-ops-blue focus:ring-ops-blue border-gray-300"></th>` : ''}
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Teacher</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Subbed For</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Details</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Hours</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Action</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    ${data.map(row => {
                      const isChecked = STATE.selectedEarned.has(row.rowIndex);
                      return `
                      <tr id="row-${row.rowIndex}" class="hover:bg-gray-50 transition ${isChecked ? 'bg-blue-50' : ''}" onclick="toggleRowSelection('earned', ${row.rowIndex}, event)">
                        ${isSel ? `
                          <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} class="rounded text-ops-blue focus:ring-ops-blue border-gray-300 pointer-events-none">
                          </td>
                        ` : ''}
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-bold text-ops-blue-dark">${row.name}</div>
                          <div class="text-xs text-ops-gray">${row.email}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-ops-gray-dark">${row.subbedFor}</td>
                        <td class="px-6 py-4 text-sm text-ops-gray">
                          <div><i class="far fa-calendar mr-1"></i> ${new Date(row.date).toLocaleDateString()}</div>
                          <div class="text-xs mt-1"><span class="bg-gray-100 px-1 rounded">${row.period}</span></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-ops-blue">+${row.hours}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm flex gap-2" onclick="event.stopPropagation()">
                           <button onclick="openEditEarnedModal(${row.rowIndex})" class="text-ops-gray-dark bg-white border border-gray-300 hover:bg-gray-50 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                          </button>
                           <!-- <button onclick="deleteItem('earned', ${row.rowIndex})" class="text-white bg-ops-red hover:bg-ops-red-dark px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                            <i class="fas fa-trash"></i>
                          </button> -->
                           <button onclick="denyEarned(${row.rowIndex})" class="text-ops-red bg-white border border-ops-red hover:bg-red-50 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95">
                            Deny
                          </button>
                          <button onclick="approveItem('earned', ${row.rowIndex})" class="text-white bg-ops-blue hover:bg-ops-blue-dark px-4 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95">
                            Approve
                          </button>
                        </td>
                      </tr>
                    `}).join('')}
                  </tbody>
                </table>
              </div>`
            }
          </div>`;
       document.getElementById('view-container').innerHTML = html;
    }

    function loadAdminUsed() {
      if (!STATE.selectedUsed) STATE.selectedUsed = new Set();

      google.script.run.withSuccessHandler(data => {
        STATE.pendingUsed = data; 
        updateBadges(); 
        renderUsedTable();
      }).getPendingUsed();
    }
    
    function renderUsedTable() {
       const data = STATE.pendingUsed || [];
       const isSel = STATE.usedSelectionMode;
       
       const batchActions = isSel ? `
          <div class="bg-red-50 px-6 py-3 border-b border-red-100 flex justify-between items-center animate-pulse-once">
            <span class="text-sm font-bold text-ops-red-dark">
              ${STATE.selectedUsed.size} Selected
            </span>
            <div class="flex gap-2">
              <button onclick="batchAction('used', 'delete')" class="bg-white text-ops-red border border-ops-red hover:bg-red-50 px-4 py-1.5 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition">
                Delete Selected
              </button>
              <button onclick="batchAction('used', 'approve')" class="bg-ops-red text-white hover:bg-ops-red-dark px-4 py-1.5 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition">
                Approve Selected
              </button>
            </div>
          </div>
        ` : '';

        const html = `
          <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-ops-red-lighter">
              <div>
                <h2 class="text-xl font-bold text-ops-red-dark">Pending Usage Requests</h2>
                <p class="text-xs text-ops-red-dark opacity-75 uppercase tracking-wider mt-1">Deduct from Balance</p>
              </div>
              <div class="flex items-center gap-3">
                 ${isSel ? `
                   <button onclick="toggleUsedSelectionMode()" class="bg-white text-gray-600 border border-gray-300 px-3 py-1 rounded shadow-sm hover:bg-gray-50 text-xs font-bold uppercase tracking-wide transition">
                     Cancel
                   </button>
                 ` : `
                   <button onclick="toggleUsedSelectionMode()" class="bg-white text-ops-red border border-ops-red px-3 py-1 rounded shadow-sm hover:bg-red-50 text-xs font-bold uppercase tracking-wide transition">
                     <i class="fas fa-check-square mr-1"></i> Select
                   </button>
                 `}
              </div>
            </div>
            ${batchActions}
            ${data.length === 0 ? '<div class="p-12 text-center"><i class="fas fa-mug-hot text-4xl text-gray-300 mb-4"></i><p class="text-ops-gray">No usage requests pending.</p></div>' : 
              `<div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      ${isSel ? `<th class="px-6 py-3 text-left bg-gray-50 w-10"><input type="checkbox" onchange="toggleSelectAll('used', this)" class="rounded text-ops-blue focus:ring-ops-blue border-gray-300"></th>` : ''}
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Teacher</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Date Used</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Amount</th>
                      <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider">Action</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    ${data.map(row => {
                      const isChecked = STATE.selectedUsed.has(row.rowIndex);
                      return `
                      <tr id="row-${row.rowIndex}" class="hover:bg-gray-50 transition ${isChecked ? 'bg-red-50' : ''}" onclick="toggleRowSelection('used', ${row.rowIndex}, event)">
                         ${isSel ? `
                          <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} class="rounded text-ops-red focus:ring-ops-red border-gray-300 pointer-events-none">
                          </td>
                        ` : ''}
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-bold text-ops-blue-dark">${row.name}</div>
                          <div class="text-xs text-ops-gray">${row.email}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-ops-gray-dark">${new Date(row.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-ops-red font-bold">-${row.used}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm flex gap-2" onclick="event.stopPropagation()">
                           <button onclick="openEditUsedModal(${row.rowIndex})" class="text-ops-gray-dark bg-white border border-gray-300 hover:bg-gray-50 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                          </button>
                           <button onclick="deleteItem('used', ${row.rowIndex})" class="text-white bg-ops-red hover:bg-ops-red-dark px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                          <button onclick="approveItem('used', ${row.rowIndex})" class="text-white bg-ops-red hover:bg-ops-red-dark px-4 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95">
                            Finalize
                          </button>
                        </td>
                      </tr>
                    `}).join('')}
                  </tbody>
                </table>
              </div>`
            }
          </div>`;
       document.getElementById('view-container').innerHTML = html;
    }

    function loadAdminTotals() {
      // Reset selection state on load
      STATE.selectionMode = false;
      STATE.selectedEmails = new Set();
      
      google.script.run.withSuccessHandler(staffData => {
        STATE.user.staffData = staffData;
        renderAdminTotalsTable(staffData);
      }).getStaffDirectoryData();
    }

    function toggleSelectionMode() {
      STATE.selectionMode = !STATE.selectionMode;
      STATE.selectedEmails = new Set(); // Reset selection
      renderAdminTotalsTable(STATE.user.staffData);
    }

    function toggleSelectAll(checkbox) {
      const isChecked = checkbox.checked;
      STATE.selectedEmails = new Set();
      
      if (isChecked) {
        // Only select currently visible/filtered rows if possible? 
        // For simplicity, let's select all in the current rendered list.
        // We'll rely on the DOM or re-scan the data. 
        // Better: Use the data passed to render logic if available, but here we just have STATE.user.staffData.
        // Let's assume we want to select ALL visible in the table (which might be filtered).
        // Since filtering happens via DOM manipulation in 'filterStaffTable' (likely), we might grab all visible inputs.
        // But 'filterStaffTable' hides rows.
        
        // Actually, let's just select ALL data for now to be safe/consistent, or just what is visible.
        // The user asked for "select all checkbox in the header row".
        // Let's assume selecting all relevant to the view.
        
        STATE.user.staffData.forEach(s => STATE.selectedEmails.add(s.email));
      }
      
      renderAdminTotalsTable(STATE.user.staffData);
    }

    function toggleStaffSelection(email) {
      if (STATE.selectedEmails.has(email)) {
        STATE.selectedEmails.delete(email);
      } else {
        STATE.selectedEmails.add(email);
      }
      updateSendButton();
    }
    
    function updateSendButton() {
       const btn = document.getElementById('btn-send-reports');
       if(btn) {
         const count = STATE.selectedEmails.size;
         btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i> Send to Selected (${count})`;
         btn.disabled = count === 0;
         btn.className = count === 0 
           ? "bg-gray-300 text-gray-500 px-4 py-2 rounded shadow-sm cursor-not-allowed text-sm font-medium transition-colors"
           : "bg-ops-blue text-white px-4 py-2 rounded shadow hover:bg-ops-blue-dark text-sm font-medium transition-colors";
       }
    }

    function sendSelectedReports() {
      const count = STATE.selectedEmails.size;
      if (count === 0) return;

      openConfirmModal(
        "Send Reports?",
        `Are you sure you want to send email reports to <strong>${count}</strong> staff members?`,
        () => {
           showLoading(true);
           const emails = Array.from(STATE.selectedEmails);
           google.script.run.withSuccessHandler(res => {
             showLoading(false);
             showToast(`Sent: ${res.success}, Failed: ${res.failed}`, res.failed > 0 ? "warning" : "success");
             toggleSelectionMode(); // Exit mode
           }).sendBatchStatusEmails(emails);
        },
        "Yes, Send All"
      );
    }

    // --- Batch Selection Logic ---
    
    function toggleEarnedSelectionMode() {
      STATE.earnedSelectionMode = !STATE.earnedSelectionMode;
      STATE.selectedEarned = new Set(); // Reset
      renderEarnedTable(); // Re-render instantly
    }

    function toggleUsedSelectionMode() {
      STATE.usedSelectionMode = !STATE.usedSelectionMode;
      STATE.selectedUsed = new Set(); // Reset
      renderUsedTable(); // Re-render instantly
    }

    function toggleRowSelection(type, id, event) {
      if(event && event.target.tagName === 'BUTTON') return; // Ignore button clicks

      const set = type === 'earned' ? STATE.selectedEarned : STATE.selectedUsed;
      if (set.has(id)) set.delete(id);
      else set.add(id);
      
      // Re-render to update UI instantly
      if (type === 'earned') renderEarnedTable();
      else renderUsedTable();
    }

    function toggleSelectAll(type, checkbox) {
      const isChecked = checkbox.checked;
      const set = type === 'earned' ? STATE.selectedEarned : STATE.selectedUsed;
      const data = type === 'earned' ? STATE.pendingEarned : STATE.pendingUsed;
      
      set.clear();
      if (isChecked) {
        data.forEach(r => set.add(r.rowIndex));
      }
      
      if (type === 'earned') renderEarnedTable();
      else renderUsedTable();
    }

    function batchAction(type, action) {
      const set = type === 'earned' ? STATE.selectedEarned : STATE.selectedUsed;
      const indices = Array.from(set);
      
      if (indices.length === 0) return showToast("No items selected.", "error");

      const actionName = action === 'approve' ? 'Approve' : (type === 'used' ? 'Delete' : 'Deny');
      
      let warning = `Are you sure you want to <strong>${actionName}</strong> ${indices.length} requests?`;
      
      // Specific warning for Denying Earned Requests (No Email)
      if (type === 'earned' && action === 'deny') {
        warning += `<div class="mt-4 bg-red-50 border-l-4 border-red-500 p-3 text-left">
           <p class="font-bold text-red-700 text-xs uppercase mb-1">Warning</p>
           <p class="text-sm text-red-900">Denying multiple requests will <strong>NOT</strong> send notification emails to teachers because you cannot provide specific reasons for each denial.</p>
        </div>`;
      }

      openConfirmModal(
        `Batch ${actionName}`,
        warning,
        () => {
           showLoading(true);
           const handler = `batch${action.charAt(0).toUpperCase() + action.slice(1)}${type.charAt(0).toUpperCase() + type.slice(1)}`; // e.g. batchApproveEarned
           
           google.script.run.withSuccessHandler(() => {
             showLoading(false);
             showToast(`Batch ${actionName} successful.`, "success");
             
             // Force full reload to ensure data freshness
             if(type === 'earned') {
               STATE.earnedSelectionMode = false;
               STATE.selectedEarned = new Set();
               loadAdminEarned();
             } else {
               STATE.usedSelectionMode = false;
               STATE.selectedUsed = new Set();
               loadAdminUsed();
             }
           }).withFailureHandler(err => {
             showLoading(false);
             showToast("Batch Error: " + err, "error");
           })[handler](indices);
        },
        `Confirm ${actionName}`,
        action === 'deny' || action === 'delete' ? 'bg-ops-red hover:bg-ops-red-dark' : 'bg-ops-blue hover:bg-ops-blue-dark'
      );
    }

    function renderAdminTotalsTable(staffList) {
       // Preserve search query if re-rendering
       const searchInput = document.querySelector('#view-container input[type="text"]');
       const currentQuery = searchInput ? searchInput.value : "";
       
       const isSel = STATE.selectionMode;
       
       const html = `
          <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center gap-4">
               <div class="relative flex-grow">
                 <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                   <i class="fas fa-search"></i>
                 </span>
                 <input type="text" value="${currentQuery}" placeholder="Search staff directory..." onkeyup="filterStaffTable(this.value)" class="w-full pl-10 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-ops-blue focus:border-transparent text-sm">
               </div>
               
               <div class="flex items-center gap-2">
                 ${isSel ? `
                   <button onclick="toggleSelectionMode()" class="bg-white text-gray-600 border border-gray-300 px-4 py-2 rounded shadow-sm hover:bg-gray-50 text-sm font-medium transition-colors">
                     Cancel
                   </button>
                   <button id="btn-send-reports" onclick="sendSelectedReports()" disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded shadow-sm cursor-not-allowed text-sm font-medium transition-colors">
                     <i class="fas fa-paper-plane mr-2"></i> Send to Selected (0)
                   </button>
                 ` : `
                   <button onclick="toggleSelectionMode()" class="bg-white text-ops-blue border border-ops-blue px-4 py-2 rounded shadow-sm hover:bg-blue-50 text-sm font-medium transition-colors whitespace-nowrap">
                     <i class="fas fa-check-square mr-2"></i> Select / Send Reports
                   </button>
                 `}
               </div>
            </div>
            <div class="overflow-x-auto max-h-[70vh]">
              <table class="min-w-full divide-y divide-gray-200" id="staff-totals-table">
                <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                  <tr>
                    ${isSel ? `<th class="px-6 py-3 text-left bg-gray-50"><input type="checkbox" onchange="toggleSelectAll(this)" class="rounded text-ops-blue focus:ring-ops-blue border-gray-300"></th>` : ''}
                    <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider bg-gray-50">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider bg-gray-50">Earned</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider bg-gray-50">Used</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-ops-gray uppercase tracking-wider bg-gray-50">Balance</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${staffList.map(s => {
                    const isChecked = STATE.selectedEmails && STATE.selectedEmails.has(s.email);
                    return `
                    <tr onclick="openStaffDetail('${s.email}', '${s.name}')" class="cursor-pointer hover:bg-ops-blue-lighter transition-colors group">
                      ${isSel ? `
                        <td class="px-6 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                          <input type="checkbox" onchange="toggleStaffSelection('${s.email}', this)" ${isChecked ? 'checked' : ''} class="rounded text-ops-blue focus:ring-ops-blue border-gray-300">
                        </td>
                      ` : ''}
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-ops-blue-dark group-hover:text-ops-blue">${s.name}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-ops-blue font-semibold">${Number(s.earned).toFixed(2)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-ops-red font-semibold">${Number(s.used).toFixed(2)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${s.total < 0 ? 'text-ops-red' : 'text-ops-gray-dark'} bg-gray-50">${Number(s.total).toFixed(2)}</td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
          </div>`;
        document.getElementById('view-container').innerHTML = html;
        
        // Restore filter and focus
        if(currentQuery) {
          filterStaffTable(currentQuery);
          const newInput = document.querySelector('#view-container input[type="text"]');
          if(newInput) {
            newInput.focus();
            newInput.setSelectionRange(newInput.value.length, newInput.value.length);
          }
        }
        
        if(isSel) updateSendButton(); 
    }

    // --- Teacher Views ---

    function renderTeacherSubmit() {
      const staffOptions = STATE.user.staffData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
      
      const html = `
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
          <div class="bg-ops-blue px-6 py-4 border-b border-blue-800">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-pencil-alt mr-2"></i>Submit Earned TST</h2>
            <p class="text-blue-200 text-sm mt-1">Log hours when you sub for a colleague.</p>
          </div>
          <div class="p-8">
            <form onsubmit="handleTeacherSubmit(event)">
              <div class="mb-6">
                <label class="block text-sm font-bold text-ops-gray-dark mb-2">I subbed for:</label>
                <div class="relative">
                  <select id="t-sub-type" onchange="toggleOther(this.value)" class="block w-full rounded border-gray-300 shadow-sm focus:border-ops-blue focus:ring focus:ring-ops-blue focus:ring-opacity-50 p-2 border bg-gray-50">
                    <option value="Staff">A Staff Member</option>
                    <option value="Other">Other (Manual Entry)</option>
                  </select>
                </div>
              </div>

              <div class="mb-6 p-4 bg-gray-50 rounded border border-gray-200">
                <div id="div-sub-dropdown">
                  <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Select Staff Member</label>
                  <select name="subbedNameDropdown" class="block w-full rounded border-gray-300 p-2 border">
                     ${staffOptions}
                  </select>
                </div>

                <div class="hidden" id="div-sub-manual">
                  <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Enter Name (Manual)</label>
                  <input type="text" name="subbedNameManual" placeholder="e.g. Guest Speaker / Admin Coverage" class="block w-full rounded border-gray-300 p-2 border">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                  <label class="block text-sm font-bold text-ops-gray-dark mb-2">Date</label>
                  <input type="date" name="date" required class="block w-full rounded border-gray-300 p-2 border focus:border-ops-blue focus:ring-1 focus:ring-ops-blue">
                </div>
                <div>
                  <label class="block text-sm font-bold text-ops-gray-dark mb-2">Period</label>
                  <select name="period" class="block w-full rounded border-gray-300 p-2 border bg-gray-50 focus:border-ops-blue focus:ring focus:ring-ops-blue focus:ring-opacity-50">
                    ${getPeriodOptions('1')}
                  </select>
                </div>
              </div>

              <div class="mb-8">
                <label class="block text-sm font-bold text-ops-gray-dark mb-2">Duration</label>
                <div class="flex gap-4">
                  <label class="flex-1 cursor-pointer">
                    <input type="radio" name="duration" value="1" checked class="peer sr-only">
                    <div class="rounded-lg border border-gray-300 p-4 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                      <div class="font-bold">Full Period</div>
                    </div>
                  </label>
                  <label class="flex-1 cursor-pointer">
                    <input type="radio" name="duration" value="0.5" class="peer sr-only">
                    <div class="rounded-lg border border-gray-300 p-4 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                      <div class="font-bold">Half Period</div>
                    </div>
                  </label>
                </div>
              </div>

              <button type="submit" class="w-full bg-ops-blue text-white font-bold py-3 px-4 rounded shadow hover:bg-ops-blue-dark transition transform active:scale-95 uppercase tracking-wide">
                Submit Request
              </button>
            </form>
          </div>
        </div>`;
      document.getElementById('view-container').innerHTML = html;
    }

    function renderTeacherRequest() {
      const currentUserData = STATE.user.staffData.find(s => s.email === STATE.user.email);
      const maxHours = currentUserData ? currentUserData.total : 0;

      const html = `
        <div class="max-w-xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
           <div class="bg-ops-red px-6 py-4 border-b border-red-800">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-calendar-minus mr-2"></i>Request TST Usage</h2>
            <p class="text-red-100 text-sm mt-1">Redeem your earned hours.</p>
          </div>
          
          <div class="p-8">
            <div class="bg-ops-blue-lighter p-4 rounded-lg mb-6 flex items-center justify-between border border-blue-200">
              <span class="text-ops-blue-dark font-medium">Available Balance</span>
              <span class="text-2xl font-bold text-ops-blue">${Number(maxHours).toFixed(2)} <span class="text-sm font-normal text-ops-gray">hrs</span></span>
            </div>

            <form onsubmit="handleUsageSubmit(event, '${STATE.user.email}', '${STATE.user.name}', ${maxHours})">
              
              <div class="mb-6">
                <label class="block text-sm font-bold text-ops-gray-dark mb-2">Date of Usage</label>
                <input type="date" name="date" required class="block w-full rounded border-gray-300 shadow-sm border p-2 focus:border-ops-red focus:ring-1 focus:ring-ops-red">
              </div>

              <div class="mb-8">
                <label class="block text-sm font-bold text-ops-gray-dark mb-2">Hours Used</label>
                <input type="number" name="amount" step="0.5" min="0.5" max="${maxHours}" required class="block w-full rounded border-gray-300 shadow-sm border p-2 focus:border-ops-red focus:ring-1 focus:ring-ops-red font-mono text-lg">
                <p class="text-xs text-ops-red mt-2"><i class="fas fa-info-circle"></i> Cannot exceed available balance.</p>
              </div>

              <button type="submit" ${maxHours <= 0 ? 'disabled' : ''} class="w-full bg-ops-red text-white font-bold py-3 px-4 rounded shadow hover:bg-ops-red-dark disabled:opacity-50 disabled:cursor-not-allowed transition uppercase tracking-wide">
                Submit Request
              </button>
            </form>
          </div>
        </div>`;
      document.getElementById('view-container').innerHTML = html;
    }

    function loadTeacherTotals() {
      const myData = STATE.user.staffData.find(s => s.email === STATE.user.email);
      if(myData) {
        openStaffDetail(STATE.user.email, STATE.user.name, true);
      }
    }


    // --- Actions & Handlers ---

    function approveItem(type, rowIndex) {
      // For now, we only have email logic for 'earned' requests
      if (type === 'earned') {
        openApproveEmailModal(rowIndex);
      } else {
        // Fallback for Used (no email needed yet per request)
        const row = document.getElementById(`row-${rowIndex}`);
        row.classList.add('opacity-50', 'pointer-events-none', 'bg-gray-100');
        google.script.run.withSuccessHandler(() => {
          row.remove();
        }).withFailureHandler(err => {
          showToast("Error approving: " + err, "error");
          row.classList.remove('opacity-50', 'pointer-events-none', 'bg-gray-100');
        }).approveUsedRow(rowIndex);
      }
    }

    function denyEarned(rowIndex) {
      openDenyEmailModal(rowIndex);
    }

    // --- New Email Modals ---

    function openApproveEmailModal(rowIndex) {
      const html = `
        <div class="text-center">
          <div class="mb-6">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
              <i class="fas fa-check text-2xl text-ops-blue"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900">Approve Request</h3>
            <p class="text-sm text-gray-500 mt-2">You are about to approve this earned time request.</p>
            <p class="text-sm text-gray-500">Would you like to send a notification email to the teacher?</p>
          </div>
          <div class="flex flex-col gap-3 sm:flex-row-reverse justify-center">
            <button onclick="submitApproveWithEmail(${rowIndex}, true)" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-ops-blue text-base font-medium text-white hover:bg-ops-blue-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ops-blue sm:text-sm">
              <i class="fas fa-paper-plane mr-2"></i> Approve & Send Email
            </button>
            <button onclick="submitApproveWithEmail(${rowIndex}, false)" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
              Approve (Skip Email)
            </button>
          </div>
        </div>
      `;
      showModal("Confirm Approval", html);
    }

    function submitApproveWithEmail(rowIndex, sendEmail) {
      closeModal();
      const row = document.getElementById(`row-${rowIndex}`);
      if(row) row.classList.add('opacity-50', 'pointer-events-none', 'bg-gray-100');
      
      google.script.run.withSuccessHandler(() => {
        if(row) row.remove();
      }).withFailureHandler(err => {
        showToast("Error approving: " + err, "error");
        if(row) row.classList.remove('opacity-50', 'pointer-events-none', 'bg-gray-100');
      }).approveEarnedRow(rowIndex, { send: sendEmail });
    }

    function openDenyEmailModal(rowIndex) {
      const html = `
        <form onsubmit="submitDenyWithEmail(event, ${rowIndex})">
          <div class="mb-4">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Reason(s) for Denial</label>
            <div class="space-y-2 bg-gray-50 p-4 rounded border border-gray-200">
              <label class="flex items-center space-x-3">
                <input type="checkbox" name="reasons" value="Incomplete Request" class="h-4 w-4 text-ops-red focus:ring-ops-red border-gray-300 rounded">
                <span class="text-sm text-gray-700">Incomplete Request</span>
              </label>
              <label class="flex items-center space-x-3">
                <input type="checkbox" name="reasons" value="Incorrect Information" class="h-4 w-4 text-ops-red focus:ring-ops-red border-gray-300 rounded">
                <span class="text-sm text-gray-700">Incorrect Information</span>
              </label>
              <label class="flex items-center space-x-3">
                <input type="checkbox" name="reasons" value="Duplicate Entry" class="h-4 w-4 text-ops-red focus:ring-ops-red border-gray-300 rounded">
                <span class="text-sm text-gray-700">Duplicate Entry</span>
              </label>
              <label class="flex items-center space-x-3">
                <input type="checkbox" name="reasons" value="Not Eligible" class="h-4 w-4 text-ops-red focus:ring-ops-red border-gray-300 rounded">
                <span class="text-sm text-gray-700">Not Eligible for TST</span>
              </label>
            </div>
          </div>
          
          <div class="mb-6">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Additional Note (Optional)</label>
            <textarea name="note" rows="3" class="shadow-sm focus:ring-ops-red focus:border-ops-red mt-1 block w-full sm:text-sm border border-gray-300 rounded-md p-3" placeholder="Add a personal message or clarification..."></textarea>
          </div>

          <div class="flex flex-col gap-3 sm:flex-row-reverse">
            <button type="submit" onclick="this.form.dataset.action='send'" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-ops-red text-base font-medium text-white hover:bg-ops-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ops-red sm:text-sm">
              <i class="fas fa-envelope mr-2"></i> Deny & Send Email
            </button>
            <button type="submit" onclick="this.form.dataset.action='skip'" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
              Deny (Skip Email)
            </button>
          </div>
        </form>
      `;
      showModal("Deny Request", html);
    }

    function submitDenyWithEmail(e, rowIndex) {
      e.preventDefault();
      const form = e.target;
      const action = form.dataset.action; // 'send' or 'skip'
      
      const reasons = Array.from(form.querySelectorAll('input[name="reasons"]:checked')).map(cb => cb.value);
      const note = form.note.value;

      closeModal();
      const row = document.getElementById(`row-${rowIndex}`);
      if(row) row.classList.add('opacity-50', 'pointer-events-none', 'bg-red-50');

      google.script.run.withSuccessHandler(() => {
        if(row) row.remove();
      }).withFailureHandler(err => {
        showToast("Error denying: " + err, "error");
        if(row) row.classList.remove('opacity-50', 'pointer-events-none', 'bg-red-50');
      }).denyEarnedRow(rowIndex, { 
        send: action === 'send',
        reasons: reasons,
        note: note
      });
    }

    function toggleOther(val) {
      if(val === 'Other') {
        document.getElementById('div-sub-dropdown').classList.add('hidden');
        document.getElementById('div-sub-manual').classList.remove('hidden');
      } else {
        document.getElementById('div-sub-dropdown').classList.remove('hidden');
        document.getElementById('div-sub-manual').classList.add('hidden');
      }
    }

    function handleTeacherSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const isOther = form.querySelector('#t-sub-type').value === 'Other';
      
      const payload = {
        email: STATE.user.email,
        subbedForType: isOther ? 'Other' : 'Staff',
        subbedForName: isOther ? form.subbedNameManual.value : form.subbedNameDropdown.value,
        date: form.date.value,
        period: form.period.value,
        amountType: form.duration.value == "1" ? "Full Period" : "Half Period",
        amountDecimal: parseFloat(form.duration.value)
      };

      showLoading(true);
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        // Simple success banner instead of alert
        const container = document.getElementById('view-container');
        container.innerHTML = `
          <div class="max-w-xl mx-auto text-center p-10">
            <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
              <i class="fas fa-check text-3xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-ops-blue-dark mb-2">Submission Received!</h2>
            <p class="text-ops-gray mb-6">Your TST earning request has been sent for approval.</p>
            <button onclick="switchTab('teacher-submit')" class="text-ops-blue font-bold hover:underline">Submit Another</button>
          </div>
        `;
      }).submitEarned(payload);
    }

    function handleUsageSubmit(e, email, name, maxHours) {
      e.preventDefault();
      const form = e.target;
      const amount = parseFloat(form.amount.value);
      
      if(amount > maxHours) {
        showToast("You cannot use more hours than you have earned.", "error");
        return;
      }

      const payload = { email, name, date: form.date.value, amount };

      showLoading(true);
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
         // Simple success banner
        const container = document.getElementById('view-container');
        container.innerHTML = `
          <div class="max-w-xl mx-auto text-center p-10">
            <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-blue-100 mb-6">
              <i class="fas fa-paper-plane text-3xl text-ops-blue"></i>
            </div>
            <h2 class="text-2xl font-bold text-ops-blue-dark mb-2">Request Sent!</h2>
            <p class="text-ops-gray mb-6">Your usage request has been submitted for processing.</p>
            <button onclick="switchTab('teacher-totals')" class="bg-ops-blue text-white px-6 py-2 rounded font-bold">View My Totals</button>
          </div>
        `;
        
        closeModal();
      }).submitUsage(payload);
    }


    // --- Modal Logic ---
    
    // --- Tabbed Admin Modal Logic (Batch) ---

    function openAdminCreateRequestModal() {
      STATE.requestQueue = []; // Reset Queue
      
      const staffList = STATE.user.staffData.sort((a,b) => a.name.localeCompare(b.name));
      const staffOptions = staffList.map(s => `<option value="${s.email}" data-name="${s.name}" data-max="${s.total}">${s.name}</option>`).join('');
      
      const html = `
        <!-- Modal Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
          <button onclick="switchAdminModalTab('earn')" id="tab-admin-earn" class="flex-1 py-3 text-sm font-bold uppercase tracking-wide border-b-2 text-ops-blue border-ops-blue bg-blue-50 focus:outline-none transition-colors">
            <i class="fas fa-plus-circle mr-2"></i> Earned Time
          </button>
          <button onclick="switchAdminModalTab('use')" id="tab-admin-use" class="flex-1 py-3 text-sm font-bold uppercase tracking-wide border-b-2 border-transparent text-gray-500 hover:text-ops-red focus:outline-none transition-colors">
            <i class="fas fa-minus-circle mr-2"></i> Usage
          </button>
        </div>

        <div class=""> <!-- Content Area (Auto Height) -->
        
          <!-- TAB 1: EARN (Blue) -->
          <div id="content-admin-earn" class="block">
             <form id="form-admin-earn">
               
               <!-- Who Earned It? -->
               <div class="mb-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label class="block text-xs font-bold text-ops-blue-dark uppercase tracking-wider mb-2">Teacher Earning Hours</label>
                  <div class="mb-2">
                     <select id="earn-teacher-select" class="block w-full rounded border-gray-300 p-2 border bg-white focus:ring-ops-blue focus:border-ops-blue">
                       <option value="">-- Select Staff Member --</option>
                       ${staffOptions}
                     </select>
                  </div>
               </div>

               <!-- Who did they sub for? -->
               <div class="mb-4">
                  <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Reason / Subbed For</label>
                  <div class="flex gap-2 mb-2">
                     <select id="earn-subtype" onchange="toggleEarnSubInput(this.value)" class="w-1/3 rounded border-gray-300 p-2 border bg-gray-50 text-sm">
                       <option value="Staff">Staff Member</option>
                       <option value="Other">Other / Manual</option>
                     </select>
                     <div id="earn-sub-staff-container" class="w-2/3">
                        <select id="earn-sub-staff-select" class="block w-full rounded border-gray-300 p-2 border">
                          <option value="">-- Select Staff --</option>
                          ${staffOptions}
                        </select>
                     </div>
                     <div id="earn-sub-manual-container" class="w-2/3 hidden">
                        <input type="text" id="earn-sub-manual-input" placeholder="e.g. Field Trip" class="block w-full rounded border-gray-300 p-2 border">
                     </div>
                  </div>
               </div>

               <!-- Details -->
               <div class="grid grid-cols-2 gap-4 mb-4">
                  <div>
                     <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Date</label>
                     <input type="date" id="earn-date" class="block w-full rounded border-gray-300 p-2 border focus:ring-ops-blue focus:border-ops-blue">
                  </div>
                  <div>
                     <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Period</label>
                     <select id="earn-period" class="block w-full rounded border-gray-300 p-2 border bg-white focus:ring-ops-blue focus:border-ops-blue">
                       ${getPeriodOptions()}
                     </select>
                  </div>
               </div>
                
               <div class="mb-6">
                  <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Duration</label>
                  <div class="flex gap-3">
                    <label class="flex-1 cursor-pointer">
                      <input type="radio" name="earn-duration" value="1" checked class="peer sr-only">
                      <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                        <div class="font-bold text-sm">Full Period</div>
                      </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                      <input type="radio" name="earn-duration" value="0.5" class="peer sr-only">
                      <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                        <div class="font-bold text-sm">Half Period</div>
                      </div>
                    </label>
                  </div>
               </div>

               <div class="flex gap-3">
                 <button type="button" onclick="addToQueue('earn')" class="flex-1 bg-white border-2 border-ops-blue text-ops-blue font-bold py-3 px-4 rounded shadow-sm hover:bg-blue-50 transition uppercase tracking-wide">
                   <i class="fas fa-plus mr-2"></i> Add Another
                 </button>
                 <button type="button" onclick="submitImmediate('earn')" class="flex-1 bg-ops-blue text-white font-bold py-3 px-4 rounded shadow-sm hover:bg-ops-blue-dark transition uppercase tracking-wide">
                   <i class="fas fa-paper-plane mr-2"></i> Submit All
                 </button>
               </div>
             </form>
          </div>

          <!-- TAB 2: USE (Red) -->
          <div id="content-admin-use" class="hidden">
             <form id="form-admin-use">
               
               <div class="mb-6 bg-red-50 p-4 rounded-lg border border-red-100">
                  <label class="block text-xs font-bold text-ops-red-dark uppercase tracking-wider mb-2">Teacher Using Hours</label>
                  <select id="use-teacher-select" onchange="updateUseBalanceHint(this)" class="block w-full rounded border-gray-300 p-2 border bg-white focus:ring-ops-red focus:border-ops-red">
                     <option value="">-- Select Staff Member --</option>
                     ${staffOptions.replace(/data-max="/g, 'data-max="')} <!-- Reusing options -->
                  </select>
                  <div id="use-balance-hint" class="text-xs text-right mt-2 text-ops-red h-4"></div>
               </div>

               <div class="grid grid-cols-2 gap-4 mb-6">
                  <div>
                     <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Date</label>
                     <input type="date" id="use-date" class="block w-full rounded border-gray-300 p-2 border focus:ring-ops-red focus:border-ops-red">
                  </div>
                  <div>
                     <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Hours Amount</label>
                     <input type="number" id="use-amount" step="0.5" min="0.5" class="block w-full rounded border-gray-300 p-2 border focus:ring-ops-red focus:border-ops-red">
                  </div>
               </div>

               <div class="mb-6">
                 <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Notes (Optional)</label>
                 <textarea id="use-notes" rows="2" placeholder="Admin notes..." class="block w-full rounded border-gray-300 p-2 border focus:ring-ops-red focus:border-ops-red"></textarea>
               </div>

               <div class="flex gap-3">
                 <button type="button" onclick="addToQueue('use')" class="flex-1 bg-white border-2 border-ops-red text-ops-red font-bold py-3 px-4 rounded shadow-sm hover:bg-red-50 transition uppercase tracking-wide">
                    <i class="fas fa-plus mr-2"></i> Add Another
                 </button>
                 <button type="button" onclick="submitImmediate('use')" class="flex-1 bg-ops-red text-white font-bold py-3 px-4 rounded shadow-sm hover:bg-ops-red-dark transition uppercase tracking-wide">
                    <i class="fas fa-paper-plane mr-2"></i> Submit All
                 </button>
               </div>
             </form>
          </div>
          
        </div>

        <!-- Queue Section (Hidden by default) -->
        <div id="queue-container" class="hidden mt-6 pt-6 border-t border-gray-200">
           <div class="flex justify-between items-center mb-3">
              <h4 class="font-bold text-ops-gray-dark uppercase tracking-wide text-sm">Submission Queue</h4>
           </div>
           <div id="queue-list" class="bg-gray-50 border border-gray-200 rounded h-32 overflow-y-auto p-2 text-sm text-gray-500">
              <!-- Items go here -->
           </div>
        </div>
      `;
      showModal("Add TST Requests (Batch)", html);
      
      // Set default date to today for convenience
      const today = new Date().toISOString().split('T')[0];
      setTimeout(() => {
          if(document.getElementById('earn-date')) document.getElementById('earn-date').value = today;
          if(document.getElementById('use-date')) document.getElementById('use-date').value = today;
      }, 100);
    }

    function addToQueue(type) {
      const initialLength = STATE.requestQueue.length;
      
      if (type === 'earn') {
        const teacherSelect = document.getElementById('earn-teacher-select');
        const email = teacherSelect.value;
        const teacherName = teacherSelect.options[teacherSelect.selectedIndex].text;
        
        if (!email) { showToast("Please select a teacher.", "error"); return false; }

        const subType = document.getElementById('earn-subtype').value;
        let subName = "";
        if (subType === 'Staff') {
           const subSelect = document.getElementById('earn-sub-staff-select');
           if(subSelect.value) {
             subName = subSelect.options[subSelect.selectedIndex].getAttribute('data-name');
           } else {
             showToast("Please select who they subbed for.", "error"); return false;
           }
        } else {
           subName = document.getElementById('earn-sub-manual-input').value;
           if(!subName) { showToast("Enter manual reason.", "error"); return false; }
        }

        const date = document.getElementById('earn-date').value;
        if(!date) { showToast("Select a date.", "error"); return false; }

        const durationVal = document.querySelector('input[name="earn-duration"]:checked').value;
        const period = document.getElementById('earn-period').value;

        STATE.requestQueue.push({
          type: 'earned',
          summary: `<strong class="text-ops-blue">Earned</strong>: ${teacherName} (Sub: ${subName}) - ${date}`,
          payload: {
            email: email,
            subbedForType: subType,
            subbedForName: subName,
            date: date,
            period: period,
            amountType: durationVal == "1" ? "Full Period" : "Half Period",
            amountDecimal: parseFloat(durationVal)
          }
        });
        
        // Reset specific fields (keep Date)
        teacherSelect.value = "";
        document.getElementById('earn-sub-staff-select').value = "";
        document.getElementById('earn-sub-manual-input').value = "";

      } else {
        // USE
        const teacherSelect = document.getElementById('use-teacher-select');
        const email = teacherSelect.value;
        const name = teacherSelect.options[teacherSelect.selectedIndex].getAttribute('data-name');
        
        if (!email) { showToast("Please select a teacher.", "error"); return false; }
        
        const date = document.getElementById('use-date').value;
        const amount = document.getElementById('use-amount').value;
        const notes = document.getElementById('use-notes').value;
        
        if (!date || !amount) { showToast("Fill all fields.", "error"); return false; }

        STATE.requestQueue.push({
          type: 'used',
          summary: `<strong class="text-ops-red">Used</strong>: ${name} (${amount} hrs) - ${date}`,
          payload: {
            email: email,
            name: name,
            date: date,
            amount: parseFloat(amount),
            notes: notes
          }
        });

        // Reset fields (Keep Date)
        teacherSelect.value = "";
        document.getElementById('use-amount').value = "";
        document.getElementById('use-notes').value = "";
        document.getElementById('use-balance-hint').innerHTML = "";
      }

      renderQueue();
      return true;
    }
    
    function submitImmediate(type) {
      // 1. Try to add current form to queue
      // Note: We check if form has data. If user clicks "Submit All" but hasn't filled the form, 
      // but there are items in the queue, we should probably just submit the queue?
      // Or assume "Submit All" includes the current form.
      // Let's assume standard behavior: validate and add current form, then submit batch.
      
      if (addToQueue(type)) {
         submitBatch();
      }
    }

    function renderQueue() {
      const list = document.getElementById('queue-list');
      const container = document.getElementById('queue-container');
      
      if (STATE.requestQueue.length === 0) {
        container.classList.add('hidden');
        list.innerHTML = '';
      } else {
        container.classList.remove('hidden');
        list.innerHTML = STATE.requestQueue.map((item, idx) => `
          <div class="flex justify-between items-center bg-white p-2 mb-2 rounded border border-gray-200 text-xs shadow-sm">
             <div>${item.summary}</div>
             <button onclick="removeFromQueue(${idx})" class="text-red-400 hover:text-red-600 ml-2">
               <i class="fas fa-times-circle"></i>
             </button>
          </div>
        `).join('');
      }
    }

    function removeFromQueue(index) {
      STATE.requestQueue.splice(index, 1);
      renderQueue();
    }

    function submitBatch() {
      if (STATE.requestQueue.length === 0) return;
      
      const queue = [...STATE.requestQueue]; // Copy
      showLoading(true);

      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        STATE.requestQueue = [];
        closeModal();
        // Refresh both views
        loadAdminEarned();
        loadAdminUsed();
        
        // Simple Toast/Alert
        showToast(`Successfully processed ${queue.length} requests.`, "success");
      }).withFailureHandler(err => {
         showLoading(false);
         showToast("Error processing batch: " + err, "error");
      }).processBatch(queue);
    }

    function switchAdminModalTab(tab) {
      const earnTab = document.getElementById('tab-admin-earn');
      const useTab = document.getElementById('tab-admin-use');
      const earnContent = document.getElementById('content-admin-earn');
      const useContent = document.getElementById('content-admin-use');

      if (tab === 'earn') {
        earnTab.classList.add('border-ops-blue', 'text-ops-blue', 'bg-blue-50');
        earnTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-ops-red');
        
        useTab.classList.remove('border-ops-red', 'text-ops-red', 'bg-red-50');
        useTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-ops-red');

        earnContent.classList.remove('hidden');
        useContent.classList.add('hidden');
      } else {
        useTab.classList.add('border-ops-red', 'text-ops-red', 'bg-red-50');
        useTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-ops-red');

        earnTab.classList.remove('border-ops-blue', 'text-ops-blue', 'bg-blue-50');
        earnTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-ops-red');

        useContent.classList.remove('hidden');
        earnContent.classList.add('hidden');
      }
    }

    function toggleEarnSubInput(val) {
      if(val === 'Other') {
        document.getElementById('earn-sub-staff-container').classList.add('hidden');
        document.getElementById('earn-sub-manual-container').classList.remove('hidden');
      } else {
        document.getElementById('earn-sub-staff-container').classList.remove('hidden');
        document.getElementById('earn-sub-manual-container').classList.add('hidden');
      }
    }

    function updateUseBalanceHint(select) {
       const option = select.options[select.selectedIndex];
       const max = option.getAttribute('data-max');
       const hintDiv = document.getElementById('use-balance-hint');
       if (max) {
         hintDiv.innerHTML = `Current Balance: <span class="font-bold">${Number(max).toFixed(2)}</span>`;
       } else {
         hintDiv.innerHTML = '';
       }
    }

    // Deprecated single-submit functions removed in place of addToQueue/submitBatch


    function openStaffDetail(email, name, isEmbedded = false) {
      showLoading(true);
      const isAdmin = STATE.user.role === 'Admin';
      const apiCall = isAdmin && !isEmbedded ? 'getStaffHistoryWithActions' : 'getTeacherHistory';

      google.script.run.withSuccessHandler(history => {
        showLoading(false);
        const staff = STATE.user.staffData.find(s => s.email === email);

        const html = `
          <div class="space-y-6">
            <div class="grid grid-cols-4 gap-4 text-center">
               <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-xs text-ops-gray uppercase tracking-wide mb-1">Carry Over</div>
                <div class="text-2xl font-bold text-ops-gray-dark">${Number(staff.carryOver || 0).toFixed(2)}</div>
              </div>
              <div class="bg-ops-blue-lighter p-4 rounded-lg border border-blue-100">
                <div class="text-xs text-ops-gray uppercase tracking-wide mb-1">Earned</div>
                <div class="text-2xl font-bold text-ops-blue">${Number(staff.earned).toFixed(2)}</div>
              </div>
              <div class="bg-ops-red-lighter p-4 rounded-lg border border-red-100">
                <div class="text-xs text-ops-gray uppercase tracking-wide mb-1">Used</div>
                <div class="text-2xl font-bold text-ops-red">${Number(staff.used).toFixed(2)}</div>
              </div>
              <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                <div class="text-xs text-ops-gray uppercase tracking-wide mb-1">Balance</div>
                <div class="text-2xl font-bold text-ops-gray-dark">${Number(staff.total).toFixed(2)}</div>
              </div>
            </div>

            <div>
              <h4 class="font-bold text-ops-blue-dark border-b pb-2 mb-3">Activity Log ${isAdmin && !isEmbedded ? '(Admin View)' : '(Finalized)'}</h4>
              <div class="max-h-96 overflow-y-auto border rounded bg-gray-50">
                <table class="min-w-full text-sm">
                  <thead class="bg-white sticky top-0">
                    <tr>
                      <th class="py-2 px-3 text-left w-24">Date</th>
                      <th class="py-2 px-3 text-left">Details</th>
                      <th class="py-2 px-3 text-center w-16">Hours</th>
                      ${isAdmin && !isEmbedded ? '<th class="py-2 px-3 text-center w-28">Actions</th>' : ''}
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    ${history.map(h => {
                       let typeBadge = '';
                       let details = '';
                       let amountClass = '';
                       let amountSign = '';
                       let rowClass = '';
                       let actions = '';

                       if(h.type === 'Earned') {
                          typeBadge = '<span class="text-xs bg-blue-100 text-ops-blue px-1.5 py-0.5 rounded mr-1">Earned</span>';
                          details = `Subbed: ${h.subbedFor}<br><span class="text-xs font-semibold text-gray-500">${h.period}</span>`;
                          amountClass = 'text-ops-blue';
                          amountSign = '+';
                          if (isAdmin && !isEmbedded) {
                            actions = `
                              <button onclick="revertTransaction('earned', ${h.rowIndex}, '${email}', '${name}', ${h.amount})" class="text-yellow-700 bg-yellow-100 hover:bg-yellow-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Revert to Pending">
                                <i class="fas fa-undo"></i> Revert
                              </button>
                              <button onclick="openEditModal('earned', ${h.rowIndex}, '${email}', '${name}', ${JSON.stringify(h).replace(/'/g, "&apos;")})" class="text-ops-blue bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                                <i class="fas fa-pencil-alt"></i> Edit
                              </button>
                              <button onclick="deleteTransaction('earned', ${h.rowIndex}, '${email}', '${name}', ${h.amount}, true)" class="text-ops-red bg-red-100 hover:bg-red-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            `;
                          }
                       } else if(h.type === 'Pending') {
                          typeBadge = '<span class="text-xs bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded mr-1">Pending</span>';
                          details = `Subbed: ${h.subbedFor}<br><span class="text-xs font-semibold text-gray-500">${h.period}</span>`;
                          amountClass = 'text-yellow-600';
                          amountSign = '+';
                          rowClass = 'bg-yellow-50';
                          if (isAdmin && !isEmbedded) {
                            actions = `
                              <button onclick="openEditModal('earned', ${h.rowIndex}, '${email}', '${name}', ${JSON.stringify(h).replace(/'/g, "&apos;")})" class="text-ops-blue bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                                <i class="fas fa-pencil-alt"></i> Edit
                              </button>
                              <button onclick="deleteTransaction('earned', ${h.rowIndex}, '${email}', '${name}', ${h.amount}, false)" class="text-ops-red bg-red-100 hover:bg-red-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            `;
                          }
                       } else if(h.type === 'Used') {
                          typeBadge = '<span class="text-xs bg-red-100 text-ops-red px-1.5 py-0.5 rounded mr-1">Used</span>';
                          details = 'Redeemed';
                          amountClass = 'text-ops-red';
                          amountSign = '-';
                          if (isAdmin && !isEmbedded) {
                            actions = `
                              <button onclick="revertTransaction('used', ${h.rowIndex}, '${email}', '${name}', ${h.amount})" class="text-yellow-700 bg-yellow-100 hover:bg-yellow-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Revert to Pending">
                                <i class="fas fa-undo"></i> Revert
                              </button>
                              <button onclick="openEditModal('used', ${h.rowIndex}, '${email}', '${name}', ${JSON.stringify(h).replace(/'/g, "&apos;")})" class="text-ops-blue bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                                <i class="fas fa-pencil-alt"></i> Edit
                              </button>
                              <button onclick="deleteTransaction('used', ${h.rowIndex}, '${email}', '${name}', ${h.amount}, true)" class="text-ops-red bg-red-100 hover:bg-red-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            `;
                          }
                       } else { // Denied
                          typeBadge = '<span class="text-xs bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded mr-1">Denied</span>';
                          details = `Request Denied (Subbed: ${h.subbedFor})<br><span class="text-xs font-semibold text-gray-500">${h.period}</span>`;
                          if (h.denialReason) {
                            details += `<div class="text-xs text-red-500 mt-0.5">${h.denialReason}</div>`;
                          }
                          amountClass = 'text-gray-400 line-through';
                          amountSign = '+';
                          rowClass = 'bg-gray-50 italic opacity-75';
                          if (isAdmin && !isEmbedded) {
                            actions = `
                              <button onclick="revertTransaction('earned', ${h.rowIndex}, '${email}', '${name}', ${h.amount})" class="text-yellow-700 bg-yellow-100 hover:bg-yellow-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Revert to Pending">
                                <i class="fas fa-undo"></i> Revert
                              </button>
                              <button onclick="openEditModal('earned', ${h.rowIndex}, '${email}', '${name}', ${JSON.stringify(h).replace(/'/g, "&apos;")})" class="text-ops-blue bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Edit">
                                <i class="fas fa-pencil-alt"></i> Edit
                              </button>
                              <button onclick="deleteTransaction('earned', ${h.rowIndex}, '${email}', '${name}', ${h.amount}, false)" class="text-ops-red bg-red-100 hover:bg-red-200 px-3 py-2 rounded shadow-sm text-xs font-bold uppercase tracking-wide transition transform active:scale-95" title="Delete">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            `;
                          }
                       }

                      return `
                      <tr class="${rowClass}">
                        <td class="py-3 px-3 text-ops-gray-dark font-medium align-top">${new Date(h.date).toLocaleDateString()}</td>
                        <td class="py-3 px-3 text-ops-gray align-top">${typeBadge} ${details}</td>
                        <td class="py-3 px-3 text-center font-bold ${amountClass} align-top">${amountSign}${h.amount}</td>
                        ${isAdmin && !isEmbedded ? `<td class="py-3 px-3 text-center align-top whitespace-nowrap">${actions}</td>` : ''}
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>

            ${!isEmbedded ? `
              <div class="mt-4 pt-4 border-t flex justify-end">
                 <button onclick="sendEmailReport('${email}', '${name}')" class="bg-ops-gray-dark text-white px-5 py-2.5 rounded shadow hover:bg-black transition text-sm font-medium">
                   <i class="fas fa-envelope mr-2"></i> Email Report
                 </button>
              </div>
            ` : ''}
          </div>
        `;

        if (isEmbedded) {
          document.getElementById('view-container').innerHTML = `
            <div class="bg-white p-8 shadow-lg rounded-lg max-w-4xl mx-auto border border-gray-200">
              <h2 class="text-2xl font-bold text-ops-blue-dark mb-6">My TST Summary</h2>
              ${html}
            </div>`;
        } else {
          showModal(name, html);
        }

      })[apiCall](email);
    }

    function sendEmailReport(email, name) {
      openConfirmModal(
        "Send Report?",
        `Send TST report email to <strong>${name}</strong>?`,
        () => {
          showLoading(true);
          google.script.run.withSuccessHandler(() => {
            showLoading(false);
            showToast("Email sent successfully.", "success");
          }).sendStatusEmail(email, name);
        },
        "Send Email"
      );
    }

    // Admin History Management Functions

    function revertTransaction(type, rowIndex, email, name, hours) {
      const typeLabel = type === 'earned' ? 'Earned' : 'Used';
      const balanceType = type === 'earned' ? 'earned' : 'used';

      openConfirmModal(
        "Revert to Pending?",
        `This will deduct <strong>${hours} hours</strong> from ${name}'s ${balanceType} balance and return this request to the pending queue.<br><br>Continue?`,
        () => {
          showLoading(true);
          const handler = type === 'earned' ? 'revertEarnedToPending' : 'revertUsedToPending';

          google.script.run
            .withSuccessHandler((result) => {
              showLoading(false);
              showToast(`${typeLabel} request reverted to pending. Balance adjusted: -${result.hoursAdjusted} hrs`, "success");

              // Refresh staff data and reopen modal
              google.script.run.withSuccessHandler(staffData => {
                STATE.user.staffData = staffData;
                openStaffDetail(email, name, false);
              }).getStaffDirectoryData();
            })
            .withFailureHandler(err => {
              showLoading(false);
              showToast("Error reverting: " + err, "error");
            })[handler](rowIndex);
        },
        "Revert to Pending",
        "bg-yellow-600 hover:bg-yellow-700"
      );
    }

    function deleteTransaction(type, rowIndex, email, name, hours, wasApproved) {
      const typeLabel = type === 'earned' ? 'Earned' : 'Used';
      const balanceType = type === 'earned' ? 'earned' : 'used';
      const balanceWarning = wasApproved
        ? `<br><br><strong>Note:</strong> This will deduct <strong>${hours} hours</strong> from ${name}'s ${balanceType} balance.`
        : '';

      openConfirmModal(
        "Delete Transaction?",
        `Are you sure you want to permanently DELETE this ${typeLabel} transaction?${balanceWarning}<br><br>This action cannot be undone.`,
        () => {
          showLoading(true);
          const handler = type === 'earned' ? 'deleteApprovedEarned' : 'deleteApprovedUsed';

          google.script.run
            .withSuccessHandler((result) => {
              showLoading(false);
              const msg = wasApproved
                ? `Transaction deleted. Balance adjusted: -${result.hoursAdjusted} hrs`
                : 'Transaction deleted successfully.';
              showToast(msg, "success");

              // Refresh staff data and reopen modal
              google.script.run.withSuccessHandler(staffData => {
                STATE.user.staffData = staffData;
                openStaffDetail(email, name, false);
              }).getStaffDirectoryData();
            })
            .withFailureHandler(err => {
              showLoading(false);
              showToast("Error deleting: " + err, "error");
            })[handler](rowIndex);
        },
        "Delete Forever",
        "bg-ops-red hover:bg-ops-red-dark"
      );
    }

    function openEditModal(type, rowIndex, email, name, historyItem) {
      const item = typeof historyItem === 'string' ? JSON.parse(historyItem) : historyItem;

      if (type === 'earned') {
        openEditEarnedModal(rowIndex, email, name, item);
      } else {
        openEditUsedModal(rowIndex, email, name, item);
      }
    }

    function openEditEarnedModal(rowIndex, email, name, item) {
      const staffOptions = STATE.user.staffData.map(s =>
        `<option value="${s.name}" ${s.name === item.subbedFor ? 'selected' : ''}>${s.name}</option>`
      ).join('');

      const dateValue = new Date(item.date).toISOString().split('T')[0];

      const modalContent = `
        <form id="edit-earned-form" onsubmit="handleEditEarnedSubmit(event, ${rowIndex}, '${email}', '${name}')">
          <div class="mb-4">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Subbed For</label>
            <input type="text" name="subbedFor" value="${item.subbedFor}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-bold text-ops-gray-dark mb-2">Date</label>
              <input type="date" name="date" value="${dateValue}" required class="block w-full rounded border-gray-300 p-2 border">
            </div>
            <div>
              <label class="block text-sm font-bold text-ops-gray-dark mb-2">Period</label>
              <select name="period" class="block w-full rounded border-gray-300 p-2 border">
                ${getPeriodOptions(item.period)}
              </select>
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Duration</label>
            <div class="flex gap-4">
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="1" ${item.amount == 1 ? 'checked' : ''} class="peer sr-only">
                <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                  <div class="font-bold">Full Period</div>
                </div>
              </label>
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="0.5" ${item.amount == 0.5 ? 'checked' : ''} class="peer sr-only">
                <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                  <div class="font-bold">Half Period</div>
                </div>
              </label>
            </div>
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-ops-blue text-white rounded hover:bg-ops-blue-dark">
              Save Changes
            </button>
          </div>
        </form>
      `;

      showModal(`Edit Earned Request - ${name}`, modalContent);
    }

    function openEditUsedModal(rowIndex, email, name, item) {
      const dateValue = new Date(item.date).toISOString().split('T')[0];

      const modalContent = `
        <form id="edit-used-form" onsubmit="handleEditUsedSubmit(event, ${rowIndex}, '${email}', '${name}')">
          <div class="mb-4">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Date of Usage</label>
            <input type="date" name="date" value="${dateValue}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>

          <div class="mb-6">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Hours Used</label>
            <input type="number" name="amount" step="0.5" min="0.5" value="${item.amount}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-ops-red text-white rounded hover:bg-ops-red-dark">
              Save Changes
            </button>
          </div>
        </form>
      `;

      showModal(`Edit Used Request - ${name}`, modalContent);
    }

    function handleEditEarnedSubmit(event, rowIndex, email, name) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const newData = {
        subbedFor: formData.get('subbedFor'),
        date: formData.get('date'),
        period: formData.get('period'),
        amountType: formData.get('duration') == '1' ? 'Full Period' : 'Half Period',
        amountDecimal: Number(formData.get('duration'))
      };

      showLoading(true);
      closeModal();

      google.script.run
        .withSuccessHandler(() => {
          showLoading(false);
          showToast("Earned request updated successfully.", "success");

          // Reopen the staff detail modal to show updated data
          openStaffDetail(email, name, false);
        })
        .withFailureHandler(err => {
          showLoading(false);
          showToast("Error updating: " + err, "error");
        })
        .updateEarnedRow(rowIndex, newData);
    }

    function handleEditUsedSubmit(event, rowIndex, email, name) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const newData = {
        date: formData.get('date'),
        amount: Number(formData.get('amount'))
      };

      showLoading(true);
      closeModal();

      google.script.run
        .withSuccessHandler(() => {
          showLoading(false);
          showToast("Used request updated successfully.", "success");

          // Reopen the staff detail modal to show updated data
          openStaffDetail(email, name, false);
        })
        .withFailureHandler(err => {
          showLoading(false);
          showToast("Error updating: " + err, "error");
        })
        .updateUsedRow(rowIndex, newData);
    }

    function deleteItem(type, rowIndex) {
      openConfirmModal(
        "Confirm Deletion", 
        "Are you sure you want to DELETE this request? This action cannot be undone.",
        () => {
          const row = document.getElementById(`row-${rowIndex}`);
          if(row) row.classList.add('opacity-50', 'pointer-events-none', 'bg-red-50');

          const handler = type === 'earned' ? 'deleteEarnedRow' : 'deleteUsedRow';

          google.script.run.withSuccessHandler(() => {
            if(row) row.remove();
            showToast("Request deleted successfully.", "success");
            
            // Update Cache
            if (type === 'earned') {
               STATE.pendingEarned = STATE.pendingEarned.filter(r => r.rowIndex !== rowIndex);
            } else {
               STATE.pendingUsed = STATE.pendingUsed.filter(r => r.rowIndex !== rowIndex);
            }
            updateBadges();

          }).withFailureHandler(err => {
            showToast("Error deleting: " + err, "error");
            if(row) row.classList.remove('opacity-50', 'pointer-events-none', 'bg-red-50');
          })[handler](rowIndex);
        },
        "Delete Forever",
        "bg-ops-red hover:bg-ops-red-dark focus:ring-ops-red"
      );
    }

    function openEditEarnedModal(rowIndex) {
      const row = STATE.pendingEarned.find(r => r.rowIndex === rowIndex);
      if(!row) return showToast("Error: Row not found in cache.", "error");

      // Format date for input
      const dateVal = new Date(row.date).toISOString().split('T')[0];
      const isHalf = row.hours == 0.5;

      const html = `
        <form onsubmit="submitEditEarned(event, ${rowIndex})">
          <div class="mb-4">
            <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Teacher (Earner)</label>
            <input type="text" value="${row.name}" disabled class="block w-full rounded border-gray-200 bg-gray-100 p-2 border text-gray-500">
          </div>
          <div class="mb-4">
             <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Subbed For</label>
             <input type="text" name="subbedFor" value="${row.subbedFor}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
               <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Date</label>
               <input type="date" name="date" value="${dateVal}" required class="block w-full rounded border-gray-300 p-2 border">
            </div>
            <div>
               <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Period</label>
               <select name="period" class="block w-full rounded border-gray-300 p-2 border bg-white">
                 ${getPeriodOptions(row.period)}
               </select>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Duration</label>
            <div class="flex gap-3">
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="1" ${!isHalf ? 'checked' : ''} class="peer sr-only">
                <div class="rounded border border-gray-200 p-2 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue peer-checked:text-white transition">
                  <span class="text-sm font-bold">Full</span>
                </div>
              </label>
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="0.5" ${isHalf ? 'checked' : ''} class="peer sr-only">
                <div class="rounded border border-gray-200 p-2 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue peer-checked:text-white transition">
                  <span class="text-sm font-bold">Half</span>
                </div>
              </label>
            </div>
          </div>
          <button type="submit" class="w-full bg-ops-blue text-white font-bold py-3 px-4 rounded shadow hover:bg-ops-blue-dark transition uppercase tracking-wide">
            Save Changes
          </button>
        </form>
      `;
      showModal("Edit Earned Request", html);
    }

    function submitEditEarned(e, rowIndex) {
      e.preventDefault();
      const form = e.target;
      const durationVal = form.duration.value;
      
      const payload = {
        subbedFor: form.subbedFor.value,
        date: form.date.value,
        period: form.period.value,
        amountDecimal: parseFloat(durationVal),
        amountType: durationVal == "1" ? "Full Period" : "Half Period"
      };

      showLoading(true);
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        closeModal();
        loadAdminEarned(); // Refresh table
      }).withFailureHandler(handleError).updateEarnedRow(rowIndex, payload);
    }

    function openEditUsedModal(rowIndex) {
      const row = STATE.pendingUsed.find(r => r.rowIndex === rowIndex);
      if(!row) return showToast("Error: Row not found in cache.", "error");

      const dateVal = new Date(row.date).toISOString().split('T')[0];

      const html = `
        <form onsubmit="submitEditUsed(event, ${rowIndex})">
           <div class="mb-4">
            <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Teacher (User)</label>
            <input type="text" value="${row.name}" disabled class="block w-full rounded border-gray-200 bg-gray-100 p-2 border text-gray-500">
          </div>
          <div class="mb-4">
             <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Date of Usage</label>
             <input type="date" name="date" value="${dateVal}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>
          <div class="mb-6">
            <label class="block text-xs font-bold text-ops-gray uppercase tracking-wider mb-2">Hours Used</label>
            <input type="number" name="amount" step="0.5" min="0.5" value="${row.used}" required class="block w-full rounded border-gray-300 p-2 border">
          </div>
          <button type="submit" class="w-full bg-ops-red text-white font-bold py-3 px-4 rounded shadow hover:bg-ops-red-dark transition uppercase tracking-wide">
            Save Changes
          </button>
        </form>
      `;
      showModal("Edit Usage Request", html);
    }

    function submitEditUsed(e, rowIndex) {
      e.preventDefault();
      const form = e.target;
      
      const payload = {
        date: form.date.value,
        amount: parseFloat(form.amount.value)
      };

      showLoading(true);
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        closeModal();
        loadAdminUsed(); // Refresh table
      }).withFailureHandler(handleError).updateUsedRow(rowIndex, payload);
    }

    // --- Utilities ---

    function openConfirmModal(title, message, callback, btnText = "Confirm", btnClass = "bg-ops-blue hover:bg-ops-blue-dark") {
      STATE.confirmCallback = callback;
      const html = `
        <div class="text-center">
          <div class="mb-6">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gray-100 mb-4">
               <i class="fas fa-question text-2xl text-gray-500"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900">${title}</h3>
            <p class="text-sm text-gray-500 mt-2">${message}</p>
          </div>
          <div class="flex flex-col gap-3 sm:flex-row-reverse justify-center">
            <button onclick="executeConfirmCallback()" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ops-blue sm:text-sm ${btnClass}">
              ${btnText}
            </button>
            <button onclick="closeModal()" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
              Cancel
            </button>
          </div>
        </div>
      `;
      showModal(title, html);
    }

    function executeConfirmCallback() {
      closeModal();
      if (STATE.confirmCallback) {
         STATE.confirmCallback();
         STATE.confirmCallback = null;
      }
    }
    
    function showModal(title, content) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal-backdrop').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal-backdrop').classList.add('hidden');
    }

    function showLoading(isLoading) {
      const loader = document.getElementById('app-loading');
      if(isLoading) loader.classList.remove('hidden');
      else loader.classList.add('hidden');
    }

    function filterStaffTable(query) {
      const rows = document.querySelectorAll('#staff-totals-table tbody tr');
      const q = query.toLowerCase();
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    }

    function handleError(err) {
      showLoading(false);
      showToast("System Error: " + err, "error");
    }
    
    function refreshApp() {
      document.getElementById('app-loading').classList.remove('hidden');
      document.getElementById('app-container').classList.add('hidden');
      google.script.run
        .withSuccessHandler(initApp)
        .withFailureHandler(handleError)
        .getInitialData();
    }

    // --- SCHEDULE / AVAILABILITY VIEWS ---

    const MONTHS = ["September", "October", "November", "December", "January", "February", "March", "April", "May", "June"];
    const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri"];
    const PERIODS = [
        "Period 1 - 8:10 - 8:57",
        "Period 2 - 9:01 - 9:48",
        "Period 3 - 9:52 - 10:39",
        "Period 4 - 10:43 - 11:09",
        "Period 5 - 11:11 - 11:37",
        "Period 4/5 - 10:30 - 11:37",
        "Period 6 - 11:40 - 12:06",
        "Period 7 - 12:08 - 12:34",
        "Period 6/7 - 11:40 - 12:34",
        "Period 8 - 12:37 - 1:08",
        "Period 9 - 1:12 - 1:59",
        "Period 10 - 2:03 - 2:50"
    ];

    function loadTeacherSchedule() {
       google.script.run.withSuccessHandler(data => {
         renderTeacherSchedule(data);
       }).getScheduleData();
    }

    function renderTeacherSchedule(scheduleData) {
       const userEmail = STATE.user.email;
       
       const html = `
         <div class="max-w-4xl mx-auto space-y-4">
           <div class="bg-blue-50 border-l-4 border-ops-blue p-4 rounded mb-6">
             <h2 class="text-xl font-bold text-ops-blue-dark">My Availability</h2>
             <p class="text-sm text-ops-gray-dark">Please indicate which periods you are willing to sub for each month.</p>
           </div>
           
           ${MONTHS.map((month, index) => {
             // Find user data for this month
             const monthData = scheduleData[month] || [];
             const myEntries = monthData.filter(d => d.email === userEmail);
             
             // Create map of Period -> Set(Days)
             const availabilityMap = {};
             myEntries.forEach(entry => {
                availabilityMap[entry.period] = new Set(entry.days.split(','));
             });

             return `
               <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                 <button onclick="toggleAccordion('month-${index}')" class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                   <span class="font-bold text-lg text-ops-gray-dark">${month}</span>
                   <i id="icon-month-${index}" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                 </button>
                 
                 <div id="content-month-${index}" class="hidden border-t border-gray-200">
                   <form onsubmit="saveTeacherAvailability(event, '${month}')" class="p-6">
                      <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                          <thead>
                            <tr class="text-left text-ops-gray uppercase tracking-wider text-xs">
                              <th class="pb-3 pl-2">Period</th>
                              ${DAYS.map(d => `<th class="pb-3 text-center w-16">${d}</th>`).join('')}
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-gray-100">
                            ${PERIODS.map(p => `
                              <tr>
                                <td class="py-2 pl-2 font-medium text-gray-700">${p}</td>
                                ${DAYS.map(d => {
                                  const isChecked = availabilityMap[p] && availabilityMap[p].has(d);
                                  return `
                                    <td class="py-2 text-center">
                                      <input type="checkbox" name="${p}_${d}" ${isChecked ? 'checked' : ''} class="rounded text-ops-blue focus:ring-ops-blue border-gray-300 h-4 w-4">
                                    </td>`;
                                }).join('')}
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                      <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-ops-blue text-white px-6 py-2 rounded shadow hover:bg-ops-blue-dark font-bold text-sm transition transform active:scale-95">
                          Save ${month} Availability
                        </button>
                      </div>
                   </form>
                 </div>
               </div>
             `;
           }).join('')}
         </div>
       `;
       
       document.getElementById('view-container').innerHTML = html;
    }

    function saveTeacherAvailability(e, month) {
      e.preventDefault();
      const form = e.target;
      const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
      
      // Group by Period
      const periodMap = {}; // "Period 1" -> ["Mon", "Tue"]
      checkboxes.forEach(cb => {
         const [period, day] = cb.name.split('_');
         if (!periodMap[period]) periodMap[period] = [];
         periodMap[period].push(day);
      });
      
      // Convert to List
      const availabilityList = Object.keys(periodMap).map(p => ({
         period: p,
         days: periodMap[p].join(',')
      }));
      
      showLoading(true);
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        showToast(`${month} availability saved.`, "success");
      }).saveAvailability(month, availabilityList);
    }

    function loadAdminSchedule() {
       google.script.run.withSuccessHandler(data => {
         renderAdminSchedule(data);
       }).getScheduleData();
    }

    function renderAdminSchedule(scheduleData) {
       const html = `
         <div class="space-y-4">
           <div class="flex justify-between items-center mb-4">
             <div>
               <h2 class="text-2xl font-bold text-ops-blue-dark">Master Schedule</h2>
               <p class="text-sm text-ops-gray">Find coverage by month, day, and period.</p>
             </div>
           </div>
           
           ${MONTHS.map((month, index) => {
             // We need to build a matrix: Period x Day -> [Teachers]
             // scheduleData[month] = [ { name, email, days: "Mon,Tue", period: "Period 1", hours: 5 }, ... ]
             
             const matrix = {};
             PERIODS.forEach(p => {
               matrix[p] = {};
               DAYS.forEach(d => matrix[p][d] = []);
             });
             
             (scheduleData[month] || []).forEach(entry => {
               const dayList = entry.days.split(',');
               dayList.forEach(day => {
                 if (matrix[entry.period] && matrix[entry.period][day]) {
                   matrix[entry.period][day].push(entry);
                 }
               });
             });
             
             return `
               <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                 <button onclick="toggleAccordion('admin-month-${index}')" class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition">
                   <div class="flex items-center gap-3">
                     <span class="font-bold text-lg text-ops-gray-dark">${month}</span>
                     <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">${scheduleData[month]?.length || 0} Entries</span>
                   </div>
                   <i id="icon-admin-month-${index}" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                 </button>
                 
                 <div id="content-admin-month-${index}" class="hidden border-t border-gray-200 p-1 overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border-separate" style="border-spacing: 0;">
                      <thead>
                        <tr>
                          <th class="px-4 py-3 bg-gray-50 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 z-10 border-b border-gray-200">Period</th>
                          ${DAYS.map(d => `<th class="px-4 py-3 bg-gray-50 text-left text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 min-w-[200px]">${d}</th>`).join('')}
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${PERIODS.map((p, pIndex) => `
                          <tr class="${pIndex % 2 === 1 ? 'bg-gray-50' : ''}">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 bg-gray-50 sticky left-0 z-10 border-r border-gray-200 shadow-sm">${p}</td>
                            ${DAYS.map(d => {
                               const teachers = matrix[p][d].sort((a,b) => a.hours - b.hours); // Sort by least hours first?
                               return `
                                 <td class="px-2 py-2 align-top border-r border-gray-100 last:border-r-0">
                                   <div class="space-y-2">
                                     ${teachers.length === 0 ? '<span class="text-xs text-gray-300 italic">No coverage</span>' : 
                                       teachers.map(t => {
                                         const pendingCount = t.pendingRequests ? t.pendingRequests.length : 0;
                                         let pendingIndicator = '';
                                         
                                         if (pendingCount > 0) {
                                            // 1. Build rich HTML content for the tooltip
                                            const listItems = t.pendingRequests.map(r => {
                                              // Extract "1" from "Period 1 - ..."
                                              let shortPd = r.period;
                                              const match = r.period.match(/Period\s+([0-9\/]+)/);
                                              if (match) shortPd = match[1];
                                              
                                              // Extract Last Name (Assume "First Last" or "First M. Last")
                                              const nameParts = r.subbedFor.trim().split(' ');
                                              const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : r.subbedFor;

                                              return `
                                                <div class="border-b border-blue-900/50 pb-2 mb-2 last:border-0 last:pb-0 last:mb-0">
                                                  <div class="flex justify-between items-center mb-0.5">
                                                    <span class="font-bold text-white">${new Date(r.date).toLocaleDateString()}</span>
                                                    <span class="bg-blue-900 text-blue-100 px-1.5 py-0.5 rounded text-[10px] font-medium">Pd ${shortPd}</span>
                                                  </div>
                                                  <div class="text-blue-200 truncate text-[11px]"><span class="opacity-75">Covering:</span> ${lastName}</div>
                                                </div>
                                              `;
                                            }).join('');
                                            
                                            const tooltipHtml = `
                                              <div class="font-bold text-blue-100 border-b border-blue-500/30 pb-2 mb-2 uppercase tracking-wide text-[10px] flex items-center gap-2">
                                                <i class="fas fa-clock"></i> Pending Requests (${pendingCount})
                                              </div>
                                              <div>${listItems}</div>
                                            `;
                                            
                                            // Escape quotes and remove newlines for the HTML attribute
                                            const safeTooltip = tooltipHtml
                                              .replace(/"/g, "&quot;")
                                              .replace(/'/g, "\\'")
                                              .replace(/(\r\n|\n|\r)/gm, "");

                                            pendingIndicator = `
                                              <i class="fas fa-hourglass-half text-orange-500 ml-1 cursor-help hover:text-orange-600 transition-colors" 
                                                 onmouseenter="showTooltip(event, '${safeTooltip}')" 
                                                 onmousemove="moveTooltip(event)" 
                                                 onmouseleave="hideTooltip()">
                                              </i>`;
                                         }

                                         return `
                                         <div class="flex justify-between items-center bg-blue-50 hover:bg-blue-100 p-2 rounded border border-blue-100 transition group">
                                            <div class="min-w-0">
                                              <div class="flex items-center">
                                                 <div class="text-xs font-bold text-ops-blue truncate" title="${t.name}">${t.name}</div>
                                                 ${pendingIndicator}
                                              </div>
                                              <div class="text-[10px] text-gray-500">${Number(t.hours).toFixed(1)} hrs</div>
                                            </div>
                                            <button onclick="openRequestCoverageModal('${t.email}', '${t.name.replace(/'/g, "\\'")}', '${p}', '${month}')" class="text-ops-blue bg-white hover:bg-white hover:text-ops-blue-dark border border-blue-200 rounded-full h-6 w-6 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity" title="Request Coverage">
                                              <i class="fas fa-paper-plane text-xs"></i>
                                            </button>
                                         </div>
                                       `;
                                       }).join('')
                                     }
                                   </div>
                                 </td>
                               `;
                            }).join('')}
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                 </div>
               </div>
             `;
           }).join('')}
         </div>
       `;
       
       document.getElementById('view-container').innerHTML = html;
    }

    function toggleAccordion(id) {
       const content = document.getElementById(`content-${id}`);
       const icon = document.getElementById(`icon-${id}`);
       if (content.classList.contains('hidden')) {
         content.classList.remove('hidden');
         icon.classList.add('rotate-180');
       } else {
         content.classList.add('hidden');
         icon.classList.remove('rotate-180');
       }
    }

    function openRequestCoverageModal(tEmail, tName, period, month) {
      // Default date to tomorrow or reasonable guess based on month?
      // Since month is "September", we could pick current date if match, or blank.
      
      const modalContent = `
        <form onsubmit="handleCoverageRequestSubmit(event)">
          <input type="hidden" name="teacherEmail" value="${tEmail}">
          <input type="hidden" name="teacherName" value="${tName}">
          <input type="hidden" name="period" value="${period}">
          
          <div class="mb-4 bg-blue-50 p-4 rounded border border-blue-100">
            <label class="block text-xs font-bold text-ops-blue uppercase tracking-wider mb-1">Requesting Coverage From</label>
            <div class="text-lg font-bold text-ops-blue-dark">${tName}</div>
            <div class="text-sm text-ops-gray">${period}</div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Date Needed</label>
            <input type="date" name="date" required class="block w-full rounded border-gray-300 p-2 border focus:border-ops-blue focus:ring-1 focus:ring-ops-blue">
            <p class="text-xs text-gray-400 mt-1">Month: ${month}</p>
          </div>

          <div class="mb-4">
             <label class="block text-sm font-bold text-ops-gray-dark mb-2">Duration</label>
             <div class="flex gap-4">
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="1" checked class="peer sr-only">
                <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                  <div class="font-bold">Full Period</div>
                </div>
              </label>
              <label class="flex-1 cursor-pointer">
                <input type="radio" name="duration" value="0.5" class="peer sr-only">
                <div class="rounded-lg border border-gray-300 p-3 text-center hover:bg-gray-50 peer-checked:border-ops-blue peer-checked:bg-ops-blue-lighter peer-checked:text-ops-blue-dark transition">
                  <div class="font-bold">Half Period</div>
                </div>
              </label>
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-bold text-ops-gray-dark mb-2">Who needs coverage?</label>
            <div class="relative">
               <select id="req-sub-type" onchange="toggleReqSubInput(this.value)" class="block w-full rounded border-gray-300 shadow-sm p-2 border bg-gray-50 mb-2">
                 <option value="Staff">Staff Member</option>
                 <option value="Other">Other (Manual)</option>
               </select>
               
               <div id="req-sub-staff-container">
                  <select name="subbedNameDropdown" class="block w-full rounded border-gray-300 p-2 border">
                    ${STATE.user.staffData.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                  </select>
               </div>
               <div id="req-sub-manual-container" class="hidden">
                  <input type="text" name="subbedNameManual" placeholder="e.g. Activity Bus / Meeting" class="block w-full rounded border-gray-300 p-2 border">
               </div>
            </div>
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-ops-blue text-white rounded hover:bg-ops-blue-dark font-bold shadow-sm">
              <i class="fas fa-envelope mr-2"></i> Send Request
            </button>
          </div>
        </form>
      `;
      
      showModal("Request Coverage", modalContent);
    }

    function toggleReqSubInput(val) {
       if(val === 'Other') {
         document.getElementById('req-sub-staff-container').classList.add('hidden');
         document.getElementById('req-sub-manual-container').classList.remove('hidden');
       } else {
         document.getElementById('req-sub-staff-container').classList.remove('hidden');
         document.getElementById('req-sub-manual-container').classList.add('hidden');
       }
    }

    function handleCoverageRequestSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const isOther = form.querySelector('#req-sub-type').value === 'Other';
      
      const payload = {
        teacherEmail: form.teacherEmail.value,
        teacherName: form.teacherName.value,
        subbedFor: isOther ? form.subbedNameManual.value : form.subbedNameDropdown.value,
        date: form.date.value,
        period: form.period.value,
        amountType: form.duration.value == '1' ? 'Full Period' : 'Half Period',
        amount: parseFloat(form.duration.value)
      };
      
      showLoading(true);
      closeModal();
      
      google.script.run.withSuccessHandler(() => {
        showLoading(false);
        showToast(`Request sent to ${payload.teacherName}.`, "success");
      }).withFailureHandler(err => {
        showLoading(false);
        showToast("Error sending request: " + err, "error");
      }).sendCoverageRequest(payload);
    }

  </script>
</body>
</html>